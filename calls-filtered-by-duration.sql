-- 2. Найти ситуацию, при которой длительность звонка превышает 30 минут, а 
--    непосредственно предшествующий ему звонок этого абонента – менее 5 минут.

INSERT INTO f(idcall, ks, dt, dur) VALUES
(130000, 1001, '2022-01-01 10:00:00+03', 30),
(130001, 1001, '2022-01-01 11:00:00+03', 2),
(130002, 1001, '2022-01-01 11:10:00+03', 40), -- prev dur < 5 AND current dur > 30
(130003, 1001, '2022-01-01 11:55:00+03', 40),
(130004, 1001, '2022-01-01 13:00:00+03', 5),
(130005, 1001, '2022-01-01 13:00:00+03', 50),
(130006, 1001, '2022-01-01 14:00:00+03', 1),
(130007, 1001, '2022-01-01 14:05:00+03', 2),
(130008, 1001, '2022-01-01 14:10:00+03', 3),
(130009, 1001, '2022-01-01 14:15:00+03', 4),
(130010, 1001, '2022-01-01 14:20:00+03', 60), -- prev dur < 5 AND current dur > 30
(130011, 1001, '2022-01-01 16:00:00+03', 2),
(130012, 1002, '2022-01-01 10:00:00+03', 1),
(130013, 1002, '2022-01-01 12:00:00+03', 25),
(130014, 1002, '2022-01-01 13:00:00+03', 2),
(130015, 1002, '2022-01-01 14:00:00+03', 31), -- prev dur < 5 AND current dur > 30
(130016, 1002, '2022-01-01 16:00:00+03', 1),
(130017, 1003, '2022-01-01 10:00:00+03', 40),
(130018, 1003, '2022-01-01 11:00:00+03', 2),
(130019, 1004, '2022-01-01 10:00:00+03', 40),
(130020, 1004, '2022-01-01 11:00:00+03', 2),
(130021, 1005, '2022-01-01 10:00:00+03', 40),
(130022, 1005, '2022-01-01 11:00:00+03', 2),
(130023, 1005, '2022-01-01 12:00:00+03', 40), -- prev dur < 5 AND current dur > 30
(130024, 1005, '2022-01-01 13:00:00+03', 40),
(130025, 1005, '2022-01-01 14:00:00+03', 30),
(130026, 1005, '2022-01-01 15:00:00+03', 40),
(130027, 1006, '2022-01-01 10:00:00+03', 35),
(130028, 1007, '2022-01-01 10:00:00+03', 35),
(130029, 1100, '2022-01-01 10:00:00+03', 35),
(130030, 1100, '2022-01-01 11:00:00+03', 4);

SELECT * FROM f;

/* SELECT * FROM f; ↓
 120006 | 1001 | 2018-01-01 10:00:00+03     |  20
 120007 | 1001 | 2018-01-02 10:10:00+03     |  30
 120008 | 1001 | 2018-01-03 10:00:00+03     |   2
 120009 | 1001 | 2018-01-04 10:00:00+03     |   5
 120011 | 1003 | 2018-01-03 10:00:00+03     |  10
 120012 | 1003 | 2018-01-04 10:00:00+03     |  11
 120013 | 1003 | 2018-01-05 10:00:00+03     |  15
 120014 | 1004 | 2018-01-02 10:00:00+03     |  20
 120015 | 1005 | 2018-01-08 11:00:00+03     |   3
 120016 | 1006 | 2018-01-05 10:00:00+03     |  10
 120017 | 1006 | 2018-01-06 10:00:00+03     |  10
 120018 | 1007 | 2019-07-15 07:30:26.928+03 |  21
 120033 | 1001 | 2018-01-01 11:00:00+03     |   4
 120010 | 1002 | 2018-01-07 10:00:00+03     | 160
 120027 | 1002 | 2021-11-12 11:35:35.688+03 | 100
 120028 | 1002 | 2021-11-12 11:36:02.278+03 | 100
 120029 | 1002 | 2021-11-18 14:26:24.829+03 | 100
 120030 | 1002 | 2021-11-18 14:26:58.825+03 | 100
 120031 | 1005 | 2021-11-18 15:44:40.388+03 |  20
 120032 | 1005 | 2021-11-18 15:45:19.303+03 |  50
 120035 | 1005 | 2021-11-18 15:46:59.869+03 |  50
 130000 | 1001 | 2022-01-01 10:00:00+03     |  30
 130001 | 1001 | 2022-01-01 11:00:00+03     |   2
 130002 | 1001 | 2022-01-01 11:10:00+03     |  40
 130003 | 1001 | 2022-01-01 11:55:00+03     |  40
 130004 | 1001 | 2022-01-01 13:00:00+03     |   5
 130005 | 1001 | 2022-01-01 13:00:00+03     |  50
 130006 | 1001 | 2022-01-01 14:00:00+03     |   1
 130007 | 1001 | 2022-01-01 14:05:00+03     |   2
 130008 | 1001 | 2022-01-01 14:10:00+03     |   3
 130009 | 1001 | 2022-01-01 14:15:00+03     |   4
 130010 | 1001 | 2022-01-01 14:20:00+03     |  60
 130011 | 1001 | 2022-01-01 16:00:00+03     |   2
 130012 | 1002 | 2022-01-01 10:00:00+03     |   1
 130013 | 1002 | 2022-01-01 12:00:00+03     |  25
 130014 | 1002 | 2022-01-01 13:00:00+03     |   2
 130015 | 1002 | 2022-01-01 14:00:00+03     |  31
 130016 | 1002 | 2022-01-01 16:00:00+03     |   1
 130017 | 1003 | 2022-01-01 10:00:00+03     |  40
 130018 | 1003 | 2022-01-01 11:00:00+03     |   2
 130019 | 1004 | 2022-01-01 10:00:00+03     |  40
 130020 | 1004 | 2022-01-01 11:00:00+03     |   2
 130021 | 1005 | 2022-01-01 10:00:00+03     |  40
 130022 | 1005 | 2022-01-01 11:00:00+03     |   2
 130023 | 1005 | 2022-01-01 12:00:00+03     |  40
 130024 | 1005 | 2022-01-01 13:00:00+03     |  40
 130025 | 1005 | 2022-01-01 14:00:00+03     |  30
 130026 | 1005 | 2022-01-01 15:00:00+03     |  40
 130027 | 1006 | 2022-01-01 10:00:00+03     |  35
 130028 | 1007 | 2022-01-01 10:00:00+03     |  35
 130029 | 1100 | 2022-01-01 10:00:00+03     |  35
 130030 | 1100 | 2022-01-01 11:00:00+03     |   4
*/

-- Show calls, where prev call duration < 5 and current duration > 30
-- TASK 2 SOLUTION ↓
SELECT idcall, ks, dt, dur 
FROM 
(
	SELECT *, LAG(dur, 1) OVER(PARTITION BY ks ORDER BY dt) AS prev_call_dur
	FROM f
) AS calls
WHERE dur > 30 AND prev_call_dur < 5;
-- TASK 2 SOLUTION ↑

/* Output:
 idcall |  ks  |           dt           | dur
--------+------+------------------------+-----
 130002 | 1001 | 2022-01-01 11:10:00+03 |  40
 130010 | 1001 | 2022-01-01 14:20:00+03 |  60
 130015 | 1002 | 2022-01-01 14:00:00+03 |  31
 130023 | 1005 | 2022-01-01 12:00:00+03 |  40
*/
